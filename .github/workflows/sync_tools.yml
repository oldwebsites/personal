name: Sync Tools to Personal Repo

on:
  schedule:
    - cron: '0 20 * * *'   # æ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨ 4 ç‚¹
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Download v2rayN Latest
        run: |
          API_URL="https://api.github.com/repos/2dust/v2rayN/releases/latest"
          DOWNLOAD_URL=$(curl -s $API_URL | grep "browser_download_url" | grep "windows-64-desktop.zip" | cut -d '"' -f 4)

          if [ -z "$DOWNLOAD_URL" ]; then
            echo "âŒ æœªæ‰¾åˆ° v2rayN ä¸‹è½½é“¾æŽ¥"
            exit 1
          fi

          curl -L "$DOWNLOAD_URL" -o v2rayN-latest.zip

      - name: Download FreeNodes
        run: |
          curl -L https://raw.githubusercontent.com/shuaidaoya/FreeNodes/main/nodes/base64.txt -o base64.txt

      - name: Generate README
        run: |
          UPDATE_TIME=$(date +'%Y-%m-%d %H:%M')

          FILE_V2RAY="https://ghproxy.net/https://github.com/${{ github.repository }}/blob/main/v2rayN-latest.zip"
          FILE_BASE64="https://ghproxy.net/https://github.com/${{ github.repository }}/blob/main/base64.txt"

          # å›ºå®šåŠ å…¥ä½ çš„ guize.json ä¸‰ç§é“¾æŽ¥
          GUIZE_RAW="https://raw.githubusercontent.com/${{ github.repository }}/main/guize.json"
          GUIZE_GHPROXY="https://ghproxy.net/https://raw.githubusercontent.com/${{ github.repository }}/main/guize.json"
          GUIZE_JSDELIVR="https://cdn.jsdelivr.net/gh/${{ github.repository }}@main/guize.json"

          cat > README.md <<EOF
# Auto Sync Tools

æœ¬ä»“åº“æ¯å¤©è‡ªåŠ¨åŒæ­¥ä»¥ä¸‹æ–‡ä»¶ï¼š

## ðŸ“Œ v2rayN æœ€æ–°ç‰ˆ
- æ–‡ä»¶ï¼š\`v2rayN-latest.zip\`
- ä¸‹è½½é“¾æŽ¥ï¼ˆè‡ªåŠ¨åŠ é€Ÿï¼‰ï¼š  
  **${FILE_V2RAY}**
- æ›´æ–°æ—¶é—´ï¼š\`${UPDATE_TIME}\`

## ðŸ“Œ FreeNodes Base64
- æ–‡ä»¶ï¼š\`base64.txt\`
- ä¸‹è½½é“¾æŽ¥ï¼ˆè‡ªåŠ¨åŠ é€Ÿï¼‰ï¼š  
  **${FILE_BASE64}**
- æ¥æºï¼šshuaidaoya/FreeNodes
- æ›´æ–°æ—¶é—´ï¼š\`${UPDATE_TIME}\`

---

# ðŸ“˜ è‡ªå®šä¹‰ v2rayN è·¯ç”±è§„åˆ™ï¼ˆguize.jsonï¼‰

è¿™æ˜¯ä½ è‡ªå®šä¹‰çš„è·¯ç”±è§„åˆ™æ–‡ä»¶ï¼Œä¾›æœ¬åœ° v2rayN å®¢æˆ·ç«¯äº‘ç«¯æ›´æ–°ä½¿ç”¨ã€‚

### ðŸ”— ä¸‰ç§å¯ç”¨ä¸‹è½½æ–¹å¼

| ç±»åž‹ | é“¾æŽ¥ |
|------|------|
| GitHub Raw | ${GUIZE_RAW} |
| ghproxy åŠ é€Ÿ | ${GUIZE_GHPROXY} |
| jsDelivr CDN | ${GUIZE_JSDELIVR} |

---

è‡ªåŠ¨åŒæ­¥ç”± GitHub Actions é©±åŠ¨ã€‚
EOF

      - name: Commit and Push Changes
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

          git add v2rayN-latest.zip base64.txt README.md

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update tools $(date +'%Y-%m-%d %H:%M')"
            git push
          fi
