name: Sync Tools to Personal Repo

on:
  schedule:
    - cron: '0 20 * * *'   # æ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨ 4 ç‚¹
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è¿è¡Œ

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      # è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œæ–¹ä¾¿åç»­è„šæœ¬è°ƒç”¨
      R_NAME: ${{ github.repository }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Download v2rayN Latest
        run: |
          # 1. è·å–æœ€æ–° Release çš„ä¸‹è½½é“¾æ¥
          API_URL="https://api.github.com/repos/2dust/v2rayN/releases/latest"
          DOWNLOAD_URL=$(curl -s $API_URL | grep "browser_download_url" | grep "windows-64-desktop.zip" | cut -d '"' -f 4)
          
          if [ -z "$DOWNLOAD_URL" ]; then
            echo "âŒ æœªæ‰¾åˆ° v2rayN ä¸‹è½½é“¾æ¥"
            exit 1
          fi
          
          # 2. ä¸‹è½½å¹¶ä¿å­˜
          curl -L "$DOWNLOAD_URL" -o v2rayN-latest.zip

      - name: Download FreeNodes
        run: |
          curl -L https://raw.githubusercontent.com/shuaidaoya/FreeNodes/main/nodes/base64.txt -o base64.txt

      - name: Generate README
        run: |
          # è·å–å½“å‰æ—¶é—´
          UP_TIME=$(date +'%Y-%m-%d %H:%M')
          
          # ä½¿ç”¨ echo é€è¡Œå†™å…¥ï¼Œå½»åº•é¿å… YAML ç¼©è¿›é”™è¯¯
          echo "# Auto Sync Tools" > README.md
          echo "æœ¬ä»“åº“æ¯å¤©è‡ªåŠ¨åŒæ­¥ä»¥ä¸‹æ–‡ä»¶ï¼š" >> README.md
          echo "" >> README.md
          
          echo "## ğŸ“Œ v2rayN æœ€æ–°ç‰ˆ" >> README.md
          echo "- ä¸‹è½½é“¾æ¥ï¼š**https://ghproxy.net/https://github.com/$R_NAME/blob/main/v2rayN-latest.zip**" >> README.md
          echo "- æ›´æ–°æ—¶é—´ï¼š\`$UP_TIME\`" >> README.md
          echo "" >> README.md
          
          echo "## ğŸ“Œ FreeNodes Base64" >> README.md
          echo "- ä¸‹è½½é“¾æ¥ï¼š**https://ghproxy.net/https://github.com/$R_NAME/blob/main/base64.txt**" >> README.md
          echo "- æ›´æ–°æ—¶é—´ï¼š\`$UP_TIME\`" >> README.md
          echo "" >> README.md
          
          echo "---" >> README.md
          echo "# ğŸ“˜ è‡ªå®šä¹‰è·¯ç”±è§„åˆ™ (guize.json)" >> README.md
          echo "| åŠ é€Ÿç±»å‹ | é“¾æ¥åœ°å€ |" >> README.md
          echo "|---|---|" >> README.md
          echo "| GitHub Raw | https://raw.githubusercontent.com/$R_NAME/main/guize.json |" >> README.md
          echo "| ghproxy | https://ghproxy.net/https://raw.githubusercontent.com/$R_NAME/main/guize.json |" >> README.md
          echo "| jsDelivr | https://cdn.jsdelivr.net/gh/$R_NAME@main/guize.json |" >> README.md
          echo "" >> README.md
          echo "---" >> README.md
          echo "è‡ªåŠ¨åŒæ­¥ç”± GitHub Actions é©±åŠ¨ã€‚" >> README.md

      - name: Commit and Push Changes
        run: |
          git config --global --add safe.directory /github/workspace
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          # æ·»åŠ æ–‡ä»¶
          git add v2rayN-latest.zip base64.txt README.md
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update tools $(date +'%Y-%m-%d %H:%M')"
            git push origin main
          fi
